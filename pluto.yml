#!/usr/bin/ansible-playbook
---
- name: pluto.yml
  become: true
  hosts: pluto.ajak.xyz
  gather_facts: false
  pre_tasks:
    - include_tasks: setup.yml
      tags: always
  tasks:
    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
        use: systemd
    # TODO: should probably be dependencies of the roles...
    - name: Install prerequisite packages
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      with_items:
        - docker
        - docker-compose
        - glances
        - python-docker
        - tmux
        - vim
        - wireguard-tools
    - name: Enable necessary services
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      with_items:
        - docker
        - systemd-networkd
    - name: Disable unecessary services
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped
        enabled: false
      with_items:
        - cockpit.socket
    - name: Add wireguard firewall zone
      ansible.posix.firewalld:
        zone: trusted
        interface: wg0
        permanent: true
        state: enabled
        immediate: true
    - name: Allow dns through firewall
      ansible.posix.firewalld:
        zone: FedoraServer
        service: dns
        permanent: true
        state: enabled
        immediate: true
    - include_role:
        name: "{{ host_role }}"
        apply:
          tags:
            - "{{ host_role }}"
      tags: always
      loop_control:
        loop_var: host_role
      loop: "{{ pluto_roles }}"
